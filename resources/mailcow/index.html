<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Run your own email server with Mailcow for full control over your communications.">
    <title>Self-Hosted Email Server | Freedom Lab NYC</title>
    <link rel="icon" href="../../static/img/torch transparent icocrop2.png" type="image/png">
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="../../css/tutorial-page.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=block" rel="stylesheet">
</head>
<body>
    <div class="mobile-overlay" id="mobileOverlay"></div>
    <header class="header">
        <a href="/" class="logo"><img src="../../static/img/FLNYC 2LINE+LOGO.png" alt="Freedom Lab NYC" class="logo-wide"></a>
        <nav class="nav-menu" id="navMenu">
            <a href="/classes-events/" class="nav-link">Classes & Events</a>
            <a href="/resources/" class="nav-link active">Resources</a>
            
            <a href="/contact/" class="nav-link">Contact</a>
            <a href="/join/" class="nav-btn">Join</a>
            
        </nav>
        <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
    </header>
    <main class="tutorial-content">
        <div class="tutorial-support-banner green">
            <svg viewBox="0 0 32 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="greenGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#b8e986;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#5cb025;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <g opacity="0.75">
                    <circle cx="7" cy="6" r="3.5" fill="url(#greenGradient)"/>
                    <ellipse cx="7" cy="15" rx="4" ry="5" fill="url(#greenGradient)"/>
                </g>
                <circle cx="16" cy="5" r="4.5" fill="url(#greenGradient)"/>
                <ellipse cx="16" cy="16" rx="5" ry="6" fill="url(#greenGradient)"/>
                <g opacity="0.75">
                    <circle cx="25" cy="6" r="3.5" fill="url(#greenGradient)"/>
                    <ellipse cx="25" cy="15" rx="4" ry="5" fill="url(#greenGradient)"/>
                </g>
            </svg>
            <p>These resources are written by Freedom Lab members. <a href="/join/">Join our Freedom Lab server</a> to be a part of the community and receive support directly.</p>
        </div>
        <div class="tutorial-header">
            <div class="tutorial-breadcrumb">
                <a href="/resources/">Resources</a><span>›</span><span>Self-Hosted Email Server</span>
            </div>
            <h1 class="tutorial-title">Self-Hosted Email Server</h1>
            <div class="tutorial-meta">
                <span class="tutorial-type-tag tutorial">Tutorial</span>
                <span class="tutorial-tag">Self-hosting</span>
                <span class="tutorial-tag">Privacy</span>
                <span class="tutorial-tag">Linux</span>
            </div>
            <p class="tutorial-intro">Run your own email server with Mailcow for full control over your communications.</p>
            <p>This guide covers installing <a href="https://mailcow.email/" target="_blank">Mailcow</a> on a Debian/Ubuntu VPS with Docker.</p>
        </div>

        <nav class="tutorial-toc">
            <h3>Table of Contents</h3>
            <ol>
                <li><a href="#prerequisites">Prerequisites</a></li>
                <li><a href="#secure-ssh-access">Secure SSH Access</a></li>
                <li><a href="#setup-firewall">Setup Firewall</a></li>
                <li><a href="#setup-dns-records">Setup DNS Records</a></li>
                <li><a href="#install-required-packages">Install Required Packages</a></li>
                <li><a href="#install-docker">Install Docker</a></li>
                <li><a href="#install-mailcow">Install Mailcow</a></li>
                <li><a href="#configure-mailcow">Configure Mailcow</a></li>
                <li><a href="#start-mailcow">Start Mailcow</a></li>
                <li><a href="#secure-the-admin-account">Secure the Admin Account</a></li>
                <li><a href="#add-your-domain">Add Your Domain</a></li>
                <li><a href="#add-dkim-and-dmarc-dns-records">Add DKIM and DMARC DNS Records</a></li>
                <li><a href="#create-a-mailbox">Create a Mailbox</a></li>
                <li><a href="#sending-emails-relay-service">Sending Emails (Relay Service)</a></li>
            </ol>
        </nav>

        <section class="tutorial-section" id="prerequisites">
            <h2>Prerequisites</h2>
            <ul>
                <li>A VPS running Ubuntu 24.04 (recommended) or Debian</li>
                <li>A domain name with DNS access</li>
                <li>SSH access to the server</li>
            </ul>
            <div class="callout callout-note"><svg class="callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg><div class="callout-content"><p>Most VPS providers block outbound port 25 to prevent spam. You can still receive emails, but sending requires a relay service like SendGrid (covered at the end).</p></div></div>
        </section>

        <section class="tutorial-section" id="secure-ssh-access">
            <h2>Secure SSH Access</h2>
            <p>After logging in, update your system:</p>
            <pre><code>sudo apt update && sudo apt upgrade -y</code></pre>
            <p>Edit the SSH configuration:</p>
            <pre><code>sudo vim /etc/ssh/sshd_config</code></pre>
            <p>Change the following settings (uncomment if needed):</p>
            <pre><code>Port 22222
PasswordAuthentication no
UsePAM no</code></pre>
            <p>Restart SSH:</p>
            <pre><code>sudo systemctl restart sshd</code></pre>
        </section>

        <section class="tutorial-section" id="setup-firewall">
            <h2>Setup Firewall</h2>
            <p>Mailcow uses Docker which requires iptables (not UFW). If UFW is installed, disable it:</p>
            <pre><code>sudo ufw disable
sudo apt remove ufw -y</code></pre>
            <p>Install iptables:</p>
            <pre><code>sudo apt install iptables iptables-persistent -y</code></pre>
            <p>Create a firewall script:</p>
            <pre><code>sudo vim /root/firewall.sh</code></pre>
            <p>Add the following:</p>
            <pre><code>#!/bin/bash

# Flush existing rules
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X

# Set default policies
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# Allow loopback
iptables -A INPUT -i lo -j ACCEPT

# Allow established and related connections
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow SSH
iptables -A INPUT -p tcp --dport 22222 -j ACCEPT

# Mailcow ports
iptables -A INPUT -p tcp --dport 25 -j ACCEPT    # SMTP
iptables -A INPUT -p tcp --dport 465 -j ACCEPT   # SMTPS
iptables -A INPUT -p tcp --dport 587 -j ACCEPT   # Submission
iptables -A INPUT -p tcp --dport 143 -j ACCEPT   # IMAP
iptables -A INPUT -p tcp --dport 993 -j ACCEPT   # IMAPS
iptables -A INPUT -p tcp --dport 110 -j ACCEPT   # POP3
iptables -A INPUT -p tcp --dport 995 -j ACCEPT   # POP3S
iptables -A INPUT -p tcp --dport 4190 -j ACCEPT  # Sieve
iptables -A INPUT -p tcp --dport 80 -j ACCEPT    # HTTP
iptables -A INPUT -p tcp --dport 443 -j ACCEPT   # HTTPS

# Save rules
iptables-save > /etc/iptables/rules.v4

echo "Firewall configured"</code></pre>
            <p>Make it executable and run it:</p>
            <pre><code>sudo chmod +x /root/firewall.sh
sudo /root/firewall.sh</code></pre>
        </section>

        <section class="tutorial-section" id="setup-dns-records">
            <h2>Setup DNS Records</h2>
            <p>Configure your domain's DNS with the following records (replace <code>example.com</code> with your domain and <code>YOUR_VPS_IP</code> with your server's IP):</p>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>A</td>
                            <td>mail</td>
                            <td>YOUR_VPS_IP</td>
                        </tr>
                        <tr>
                            <td>CNAME</td>
                            <td>autodiscover</td>
                            <td>mail.example.com</td>
                        </tr>
                        <tr>
                            <td>CNAME</td>
                            <td>autoconfig</td>
                            <td>mail.example.com</td>
                        </tr>
                        <tr>
                            <td>MX</td>
                            <td>@</td>
                            <td>mail.example.com</td>
                        </tr>
                        <tr>
                            <td>TXT</td>
                            <td>@</td>
                            <td>v=spf1 mx a -all</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p>The MX record tells other mail servers to deliver emails for <code>@example.com</code> to <code>mail.example.com</code>.</p>
            <div class="callout callout-note"><svg class="callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg><div class="callout-content"><p>DKIM and DMARC records will be added after installation.</p></div></div>
        </section>

        <section class="tutorial-section" id="install-required-packages">
            <h2>Install Required Packages</h2>
            <pre><code>sudo apt install -y git openssl curl gawk coreutils grep jq</code></pre>
        </section>

        <section class="tutorial-section" id="install-docker">
            <h2>Install Docker</h2>
            <p>Add Docker's official GPG key:</p>
            <pre><code>sudo apt update
sudo apt install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings</code></pre>
            <p><strong>For Ubuntu:</strong></p>
            <pre><code>sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

sudo tee /etc/apt/sources.list.d/docker.sources &lt;&lt;EOF
Types: deb
URIs: https://download.docker.com/linux/ubuntu
Suites: $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF</code></pre>
            <p><strong>For Debian:</strong></p>
            <pre><code>sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

sudo tee /etc/apt/sources.list.d/docker.sources &lt;&lt;EOF
Types: deb
URIs: https://download.docker.com/linux/debian
Suites: $(. /etc/os-release && echo "$VERSION_CODENAME")
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF</code></pre>
            <p>Install Docker:</p>
            <pre><code>sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</code></pre>
        </section>

        <section class="tutorial-section" id="install-mailcow">
            <h2>Install Mailcow</h2>
            <pre><code>sudo umask 0022
cd /opt
sudo git clone https://github.com/mailcow/mailcow-dockerized
cd mailcow-dockerized
sudo ./generate_config.sh</code></pre>
            <p>When prompted:</p>
            <ul>
                <li><strong>FQDN:</strong> Enter <code>mail.example.com</code> (not just <code>example.com</code>)</li>
                <li><strong>Timezone:</strong> Press enter for default or enter your timezone</li>
                <li><strong>Branch:</strong> Choose <code>1</code> for stable</li>
                <li><strong>IPv6:</strong> Say <code>Y</code> if prompted to create IPv6 settings</li>
            </ul>
        </section>

        <section class="tutorial-section" id="configure-mailcow">
            <h2>Configure Mailcow</h2>
            <p>Edit the configuration:</p>
            <pre><code>sudo vim mailcow.conf</code></pre>
            <p>To save resources, disable ClamAV antivirus:</p>
            <pre><code>SKIP_CLAMD=y</code></pre>
            <p>Edit Docker Compose file:</p>
            <pre><code>sudo vim docker-compose.yml</code></pre>
            <p>In the <code>redis-mailcow</code> section, comment out the <code>sysctls</code> lines (fixes an issue on some VPS):</p>
            <pre><code>#sysctls:
#  - net.core.somaxconn=4096</code></pre>
        </section>

        <section class="tutorial-section" id="start-mailcow">
            <h2>Start Mailcow</h2>
            <p>Pull images and start:</p>
            <pre><code>sudo docker compose pull
sudo docker compose up -d</code></pre>
            <p>Wait about 5 minutes, then access the admin panel at:</p>
            <pre><code>https://mail.example.com</code></pre>
            <p>Default credentials: <code>admin</code> / <code>moohoo</code></p>
            <div class="callout callout-warning"><svg class="callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><div class="callout-content"><p>Click "Log in as admin" at the bottom of the login page.</p></div></div>
        </section>

        <section class="tutorial-section" id="secure-the-admin-account">
            <h2>Secure the Admin Account</h2>
            <ol>
                <li>Go to <strong>System → Configuration</strong></li>
                <li>Under <strong>Access → Administrators</strong>, click <strong>Edit</strong> next to the admin user</li>
                <li>Set a strong password</li>
                <li>Enable <strong>Time-based OTP</strong> for 2FA</li>
            </ol>
        </section>

        <section class="tutorial-section" id="add-your-domain">
            <h2>Add Your Domain</h2>
            <ol>
                <li>Go to <strong>E-Mail → Configuration</strong></li>
                <li>Click the <strong>Domains</strong> tab</li>
                <li>Click <strong>Add Domain</strong></li>
                <li>Enter your domain (e.g., <code>example.com</code>)</li>
                <li>Click <strong>Add domain and restart SOGo</strong></li>
            </ol>
        </section>

        <section class="tutorial-section" id="add-dkim-and-dmarc-dns-records">
            <h2>Add DKIM and DMARC DNS Records</h2>
            <p>After adding your domain:</p>
            <ol>
                <li>In the Domains list, click the <strong>DNS</strong> button next to your domain</li>
                <li>Copy the DKIM key value</li>
            </ol>
            <p>Add these DNS records:</p>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>TXT</td>
                            <td>dkim._domainkey</td>
                            <td>(paste DKIM key from Mailcow)</td>
                        </tr>
                        <tr>
                            <td>TXT</td>
                            <td>_dmarc</td>
                            <td>v=DMARC1; p=reject; rua=mailto:admin@example.com</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p>You can verify your DNS configuration using: <a href="https://docs.mailcow.email/getstarted/prerequisite-dns/#testing" target="_blank">https://docs.mailcow.email/getstarted/prerequisite-dns/#testing</a></p>
        </section>

        <section class="tutorial-section" id="create-a-mailbox">
            <h2>Create a Mailbox</h2>
            <ol>
                <li>Go to <strong>E-Mail → Configuration</strong></li>
                <li>Click the <strong>Mailboxes</strong> tab</li>
                <li>Click <strong>Add Mailbox</strong></li>
                <li>Set username, full name, and password</li>
                <li>Under <strong>Encryption policy</strong>, select:
                    <ul>
                        <li>Enforce TLS incoming</li>
                        <li>Enforce TLS outgoing</li>
                    </ul>
                </li>
                <li>Uncheck <strong>Direct forwarding to SOGo</strong> (allows easier access to admin panel)</li>
                <li>Save</li>
            </ol>
            <p>Log out and log back in as the user (click "Login as user" instead of admin).</p>
            <p>Set up 2FA for the user account, then click the blue button to access webmail.</p>
        </section>

        <section class="tutorial-section" id="sending-emails-relay-service">
            <h2>Sending Emails (Relay Service)</h2>
            <p>Most VPS providers block outbound port 25 to prevent spam. You can receive emails, but sending requires a relay service.</p>
            <p><strong>How it works:</strong></p>
            <ul>
                <li>Your server connects to the relay on port 587 (not blocked)</li>
                <li>The relay delivers using their servers on port 25</li>
                <li>Emails still appear from your domain</li>
            </ul>
            <p>Popular relay services:</p>
            <ul>
                <li><a href="https://sendgrid.com/" target="_blank">SendGrid</a></li>
                <li><a href="https://www.mailgun.com/" target="_blank">Mailgun</a></li>
                <li><a href="https://aws.amazon.com/ses/" target="_blank">Amazon SES</a></li>
            </ul>
            <p>To configure a relay in Mailcow:</p>
            <ol>
                <li>Go to <strong>System → Configuration</strong></li>
                <li>Under <strong>Routing</strong>, configure your relay host with the credentials from your relay service</li>
            </ol>
        </section>

        <nav class="tutorial-nav">
            <a href="/resources/" class="tutorial-nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>Back to Tutorials</a>
        </nav>
    </main>
    <div id="footer-placeholder"></div>
    <script src="../../js/footer.js"></script>
    <script>
        const hamburger = document.getElementById('hamburger');
        const navMenu = document.getElementById('navMenu');
        const mobileOverlay = document.getElementById('mobileOverlay');
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
            mobileOverlay.classList.toggle('active');
            document.body.style.overflow = navMenu.classList.contains('active') ? 'hidden' : '';
        });
        mobileOverlay.addEventListener('click', () => {
            hamburger.classList.remove('active');
            navMenu.classList.remove('active');
            mobileOverlay.classList.remove('active');
            document.body.style.overflow = '';
        });
        // Image lightbox
        const lightbox = document.createElement('div');
        lightbox.className = 'lightbox-overlay';
        lightbox.innerHTML = '<img src="" alt="">';
        document.body.appendChild(lightbox);
        const lightboxImg = lightbox.querySelector('img');
        document.querySelectorAll('.tutorial-section img, .tutorial-header img, .callout-content img').forEach(img => {
            img.addEventListener('click', () => {
                lightboxImg.src = img.src;
                lightboxImg.alt = img.alt;
                lightbox.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
        });
        lightbox.addEventListener('click', () => {
            lightbox.classList.remove('active');
            document.body.style.overflow = '';
        });
    </script>
</body>
</html>
