<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Run your own SimpleX SMP server for private, decentralized messaging with Tor support.">
    <title>Self-Hosted SimpleX SMP Server | Freedom Lab NYC</title>
    <link rel="icon" href="../../static/img/torch transparent icocrop2.png" type="image/png">
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="../../css/tutorial-page.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=block" rel="stylesheet">
</head>
<body>
    <div class="mobile-overlay" id="mobileOverlay"></div>
    <header class="header">
        <a href="/" class="logo"><img src="../../static/img/FLNYC 2LINE+LOGO.png" alt="Freedom Lab NYC" class="logo-wide"></a>
        <nav class="nav-menu" id="navMenu">
            <a href="/classes-events/" class="nav-link">Classes & Events</a>
            <a href="/tutorials/" class="nav-link active">Tutorials</a>
            <a href="https://freedomlabnyc.github.io/classes/" class="nav-link" target="_blank">Resources</a>
            <a href="/contact/" class="nav-link">Contact</a>
            <a href="/donate/" class="nav-link">Donate</a>
            <a href="http://2iyutqpfixbdpgwd7so7zuodvqqanpjssv54fyqaessxfv6z3d7egjyd.onion" class="nav-link nav-link-onion" target="_blank">Onion Site</a>
            <a href="/join/" class="nav-btn">Join</a>
            
        </nav>
        <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
    </header>
    <main class="tutorial-content">
        <div class="tutorial-support-banner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            <p>These tutorials are written by Freedom Lab members in their free time. If you find them helpful, please consider <a href="/donate/">supporting our work</a>.</p>
        </div>
        <div class="tutorial-header">
            <div class="tutorial-breadcrumb">
                <a href="/tutorials/">Tutorials</a><span>›</span><span>Self-Hosted SimpleX SMP Server</span>
            </div>
            <h1 class="tutorial-title">Self-Hosted SimpleX SMP Server</h1>
            <div class="tutorial-meta">
                <span class="tutorial-tag">Self-hosting</span>
                <span class="tutorial-tag">Privacy</span>
                <span class="tutorial-tag">Linux</span>
            </div>
            <p class="tutorial-intro">Run your own SimpleX SMP server for private, decentralized messaging.</p>
            <p>This guide covers installing a <a href="https://simplex.chat/" target="_blank">SimpleX</a> SMP (Simple Messaging Protocol) server on a Debian/Ubuntu VPS with Tor support.</p>
        </div>

        <nav class="tutorial-toc">
            <h3>Table of Contents</h3>
            <ol>
                <li><a href="#prerequisites">Prerequisites</a></li>
                <li><a href="#secure-ssh-access">Secure SSH Access</a></li>
                <li><a href="#setup-firewall">Setup Firewall</a></li>
                <li><a href="#install-dependencies">Install Dependencies</a></li>
                <li><a href="#install-simplex-smp-server">Install SimpleX SMP Server</a></li>
                <li><a href="#initialize-the-server">Initialize the Server</a></li>
                <li><a href="#install-tor">Install Tor</a></li>
                <li><a href="#configure-tor">Configure Tor</a></li>
                <li><a href="#install-caddy">Install Caddy</a></li>
                <li><a href="#configure-caddy">Configure Caddy</a></li>
                <li><a href="#setup-certificate-script">Setup Certificate Script</a></li>
                <li><a href="#setup-certificate-renewal">Setup Certificate Renewal</a></li>
                <li><a href="#start-caddy-and-generate-certificate">Start Caddy and Generate Certificate</a></li>
                <li><a href="#start-the-smp-server">Start the SMP Server</a></li>
                <li><a href="#get-your-server-address">Get Your Server Address</a></li>
                <li><a href="#configure-simplex-client">Configure SimpleX Client</a></li>
            </ol>
        </nav>

        <section class="tutorial-section" id="prerequisites">
            <h2>Prerequisites</h2>
            <ul>
                <li>A VPS running Ubuntu 24.04 (recommended) or Debian</li>
                <li>A domain name pointing to your VPS</li>
                <li>SSH access to the server</li>
            </ul>
        </section>

        <section class="tutorial-section" id="secure-ssh-access">
            <h2>Secure SSH Access</h2>
            <p>After logging in, update your system:</p>
            <pre><code>sudo apt update && sudo apt upgrade -y</code></pre>
            <p>Edit the SSH configuration:</p>
            <pre><code>sudo vim /etc/ssh/sshd_config</code></pre>
            <p>Change the following settings (uncomment if needed):</p>
            <pre><code>Port 22222
PasswordAuthentication no
UsePAM no</code></pre>
            <p>Restart SSH:</p>
            <pre><code>sudo systemctl restart sshd</code></pre>
        </section>

        <section class="tutorial-section" id="setup-firewall">
            <h2>Setup Firewall</h2>
            <pre><code>sudo apt install ufw -y
sudo ufw allow 22222/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 5223/tcp
sudo ufw enable</code></pre>
        </section>

        <section class="tutorial-section" id="install-dependencies">
            <h2>Install Dependencies</h2>
            <pre><code>sudo apt install -y gpg curl</code></pre>
        </section>

        <section class="tutorial-section" id="install-simplex-smp-server">
            <h2>Install SimpleX SMP Server</h2>
            <p>Download and run the SimpleX installation script:</p>
            <pre><code>curl -o- https://raw.githubusercontent.com/simplex-chat/simplexmq/stable/install.sh | bash</code></pre>
            <p>When prompted, select option <code>1</code> to install the SMP server.</p>
        </section>

        <section class="tutorial-section" id="initialize-the-server">
            <h2>Initialize the Server</h2>
            <p>Initialize the SMP server with your domain (replace <code>smp.example.com</code> with your domain):</p>
            <pre><code>sudo su smp -c 'smp-server init --yes \
    --store-log \
    --no-password \
    --control-port \
    --socks-proxy \
    --source-code \
    --fqdn=smp.example.com'</code></pre>
            <div class="callout callout-warning"><svg class="callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><div class="callout-content"><p>Save the output — it contains your server's fingerprint.</p></div></div>
        </section>

        <section class="tutorial-section" id="install-tor">
            <h2>Install Tor</h2>
            <p>Install prerequisites:</p>
            <pre><code>sudo apt install -y apt-transport-https gnupg wget</code></pre>
            <p>Add the Tor Project repository. Create <code>/etc/apt/sources.list.d/tor.sources</code>:</p>
            <pre><code>CODENAME="$(lsb_release -c | awk '{print $2}')"

sudo tee /etc/apt/sources.list.d/tor.sources &lt;&lt;EOF
Types: deb deb-src
URIs: https://deb.torproject.org/torproject.org/
Suites: ${CODENAME}
Components: main
Signed-By: /usr/share/keyrings/deb.torproject.org-keyring.gpg
EOF</code></pre>
            <p>Add the GPG key:</p>
            <pre><code>wget -qO- https://deb.torproject.org/torproject.org/A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89.asc | gpg --dearmor | sudo tee /usr/share/keyrings/deb.torproject.org-keyring.gpg >/dev/null</code></pre>
            <p>Install Tor:</p>
            <pre><code>sudo apt update && sudo apt install -y tor deb.torproject.org-keyring</code></pre>
        </section>

        <section class="tutorial-section" id="configure-tor">
            <h2>Configure Tor</h2>
            <p>Create the hidden service directory:</p>
            <pre><code>sudo tor-instance-create tor2
sudo mkdir -p /var/lib/tor/simplex-smp/
sudo chown debian-tor:debian-tor /var/lib/tor/simplex-smp/
sudo chmod 700 /var/lib/tor/simplex-smp/</code></pre>
            <p>Edit <code>/etc/tor/torrc</code> and add at the bottom:</p>
            <pre><code># Enable log
Log notice file /var/log/tor/notices.log

# Enable single hop routing (reduces latency, acceptable since onion address is public)
SOCKSPort 0
HiddenServiceNonAnonymousMode 1
HiddenServiceSingleHopMode 1

# SMP server hidden service
HiddenServiceDir /var/lib/tor/simplex-smp/
HiddenServicePort 5223 localhost:5223
HiddenServicePort 443 localhost:443</code></pre>
            <p>Edit <code>/etc/tor/instances/tor2/torrc</code> and replace the contents with:</p>
            <pre><code># Log tor to systemd daemon
Log notice syslog

# Listen to local 9050 port for socks proxy
SocksPort 9050</code></pre>
            <p>Enable and start Tor:</p>
            <pre><code>sudo systemctl enable tor
sudo systemctl start tor
sudo systemctl restart tor
sudo systemctl enable --now tor@tor2</code></pre>
        </section>

        <section class="tutorial-section" id="install-caddy">
            <h2>Install Caddy</h2>
            <p>Install Caddy for TLS certificates:</p>
            <pre><code>sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https curl

curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg

curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list

sudo apt update && sudo apt install -y caddy</code></pre>
        </section>

        <section class="tutorial-section" id="configure-caddy">
            <h2>Configure Caddy</h2>
            <p>Edit <code>/etc/caddy/Caddyfile</code> and replace the contents with (use your domain):</p>
            <pre><code>http://smp.example.com {
    redir https://smp.example.com{uri} permanent
}

smp.example.com:8443 {
    tls {
        key_type rsa4096
    }
}</code></pre>
        </section>

        <section class="tutorial-section" id="setup-certificate-script">
            <h2>Setup Certificate Script</h2>
            <p>Create the certificate script:</p>
            <pre><code>sudo vim /usr/local/bin/simplex-servers-certs</code></pre>
            <p>Add the following (replace <code>smp.example.com</code> with your domain):</p>
            <pre><code>#!/usr/bin/env sh
set -eu

user='smp'
group="$user"

domain='smp.example.com'
folder_in="/var/lib/caddy/.local/share/caddy/certificates/acme-v02.api.letsencrypt.org-directory/${domain}"
folder_out='/etc/opt/simplex'
key_name='web.key'
cert_name='web.crt'

# Copy certificate from Caddy directory to smp-server directory
cp "${folder_in}/${domain}.crt" "${folder_out}/${cert_name}"
chown "$user":"$group" "${folder_out}/${cert_name}"

# Copy certificate key from Caddy directory to smp-server directory
cp "${folder_in}/${domain}.key" "${folder_out}/${key_name}"
chown "$user":"$group" "${folder_out}/${key_name}"</code></pre>
            <p>Make it executable:</p>
            <pre><code>sudo chmod +x /usr/local/bin/simplex-servers-certs</code></pre>
        </section>

        <section class="tutorial-section" id="setup-certificate-renewal">
            <h2>Setup Certificate Renewal</h2>
            <p>Add a cron job for automatic certificate renewal:</p>
            <pre><code>sudo crontab -e</code></pre>
            <p>Add at the bottom:</p>
            <pre><code># Every week on Sunday at 00:20
20 0 * * 0 /usr/local/bin/simplex-servers-certs</code></pre>
        </section>

        <section class="tutorial-section" id="start-caddy-and-generate-certificate">
            <h2>Start Caddy and Generate Certificate</h2>
            <p>Enable Caddy and wait for the certificate to be generated:</p>
            <pre><code>sudo systemctl enable --now caddy</code></pre>
            <p>Wait a few minutes for Caddy to obtain the certificate, then run:</p>
            <pre><code>sudo systemctl restart caddy
sudo /usr/local/bin/simplex-servers-certs</code></pre>
            <div class="callout callout-note"><svg class="callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg><div class="callout-content"><p>If the certificate script fails, wait a few more minutes and try again. Caddy needs time to obtain the certificate from Let's Encrypt.</p></div></div>
        </section>

        <section class="tutorial-section" id="start-the-smp-server">
            <h2>Start the SMP Server</h2>
            <pre><code>sudo systemctl enable --now smp-server.service</code></pre>
        </section>

        <section class="tutorial-section" id="get-your-server-address">
            <h2>Get Your Server Address</h2>
            <p>Run this to display your server addresses:</p>
            <pre><code>smp="$(journalctl --output cat -q _SYSTEMD_INVOCATION_ID="$(systemctl show -p InvocationID --value smp-server)" | grep -m1 'Server address:' | awk '{print $NF}' | sed 's/:443.*//')"
tor="$(cat /var/lib/tor/simplex-smp/hostname)"

echo "Clearweb: ${smp}"
echo "Tor: ${smp%@*}@${tor}"</code></pre>
            <p>You'll get two addresses:</p>
            <ul>
                <li><strong>Clearweb:</strong> <code>smp://FINGERPRINT@smp.example.com</code></li>
                <li><strong>Tor:</strong> <code>smp://FINGERPRINT@youronionaddress.onion</code></li>
            </ul>
        </section>

        <section class="tutorial-section" id="configure-simplex-client">
            <h2>Configure SimpleX Client</h2>
            <p>In the SimpleX app:</p>
            <ol>
                <li>Go to <strong>Settings → Network & Servers</strong></li>
                <li>Go to <strong>Your Servers → Add server → Enter Server manually</strong></li>
                <li>Enter your server address (clearweb or Tor)</li>
                <li>Check <strong>Use for new connections</strong></li>
                <li>Save</li>
            </ol>
            <p>To use only your server:</p>
            <ol>
                <li>Disable the default Flux servers</li>
                <li>In SimpleX servers, keep <strong>Use Servers</strong> on (needed for files if you don't have XFTP)</li>
                <li>Uncheck <strong>To Receive</strong> and <strong>For Private Routing</strong> under "Use for messages"</li>
            </ol>
            <p>Your conversations will now show "receiving via" your server address.</p>
        </section>

        <nav class="tutorial-nav">
            <a href="/tutorials/" class="tutorial-nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>Back to Tutorials</a>
        </nav>
    </main>
    <footer class="site-footer">
        <div class="footer-social">
            <a href="/contact/" class="footer-social-link" aria-label="Email"><svg viewBox="0 0 24 24" fill="currentColor" class="footer-social-svg"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></a>
            <a href="https://primal.net/p/nprofile1qqsrzwgcg39ck26lc3e2yfjhntgcecnlgy9evsuxrfsxx6p46r5s3pgzdvhyj" target="_blank" class="footer-social-link" aria-label="Nostr"><img src="../../static/img/nostr_logo.png" alt="Nostr" class="footer-social-icon"></a>
            <a href="https://x.com/freedomlabnyc" target="_blank" class="footer-social-link" aria-label="X"><svg viewBox="0 0 24 24" fill="currentColor" class="footer-social-svg"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
            <a href="https://www.linkedin.com/company/freedom-lab-nyc/" target="_blank" class="footer-social-link" aria-label="LinkedIn"><svg viewBox="0 0 24 24" fill="currentColor" class="footer-social-svg"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
        </div>
    </footer>
    <script>
        const hamburger = document.getElementById('hamburger');
        const navMenu = document.getElementById('navMenu');
        const mobileOverlay = document.getElementById('mobileOverlay');
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
            mobileOverlay.classList.toggle('active');
            document.body.style.overflow = navMenu.classList.contains('active') ? 'hidden' : '';
        });
        mobileOverlay.addEventListener('click', () => {
            hamburger.classList.remove('active');
            navMenu.classList.remove('active');
            mobileOverlay.classList.remove('active');
            document.body.style.overflow = '';
        });
        // Image lightbox
        const lightbox = document.createElement('div');
        lightbox.className = 'lightbox-overlay';
        lightbox.innerHTML = '<img src="" alt="">';
        document.body.appendChild(lightbox);
        const lightboxImg = lightbox.querySelector('img');
        document.querySelectorAll('.tutorial-section img, .tutorial-header img, .callout-content img').forEach(img => {
            img.addEventListener('click', () => {
                lightboxImg.src = img.src;
                lightboxImg.alt = img.alt;
                lightbox.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
        });
        lightbox.addEventListener('click', () => {
            lightbox.classList.remove('active');
            document.body.style.overflow = '';
        });
    </script>
</body>
</html>
